<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæƒ…æ„Ÿäº¤äº’ç•Œé¢</title>
    <style>
        body {
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .response-box {
            width: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 32px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .emoji-container {
            text-align: center;
            margin-bottom: 24px;
            animation: emoji-enter 0.5s ease;
        }

        .emoji {
            font-size: 50px;
            display: inline-block;
            transform-origin: center bottom;
            animation: emoji-bounce 1.2s infinite;
        }

        .response-text {
            font-size: 20px;
            color: #333;
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            background: #f8f9fa;
            height: 80px;
        }
        
        .voice-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        
        #status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            background: #ccc;
        }
        
        #status.active {
            background: #00c853;
            animation: pulse 1s infinite;
        }
        
        #transcript {
            width: 600px;
            border: 1px solid #ddd;
            min-height: 100px;
            padding: 1rem;
            margin: 1rem 0;
            white-space: pre-wrap;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .interim {
            color: #666;
            font-style: italic;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #1890ff;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            margin: 0 5px;
        }
        
        button:hover {
            background: #40a9ff;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .warning-message {
            color: #ff4d4f;
            font-weight: bold;
        }

        .input-area {
            display: flex;
            width: 600px;
            margin-top: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
        }
        
        @keyframes emoji-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* ç¼©æ”¾å’Œæ·¡å…¥ */
        @keyframes emoji-enter {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0,200,83,0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0,200,83,0); }
            100% { box-shadow: 0 0 0 0 rgba(0,200,83,0); }
        }
    </style>
</head>
<body>
    <div class="response-box">
        <div class="emoji-container">
            <span class="emoji">ğŸ¤–</span>
        </div>
        <div class="response-text" id="responseContent">
            ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
        </div>
        
        <div class="voice-controls">
            <span id="status"></span>
            <button id="toggleBtn">å¼€å§‹è¯­éŸ³è¯†åˆ«</button>
        </div>
    </div>

    <div id="transcript"></div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...">
        <button id="sendBtn">å‘é€</button>
    </div>

    <script>
        // åç«¯APIåœ°å€
        const API_BASE_URL = 'http://localhost:8081/api';
        
        // è·å–DOMå…ƒç´ 
        const emojiElement = document.querySelector('.emoji');
        const responseElement = document.getElementById('responseContent');
        const transcriptElement = document.getElementById('transcript');
        const statusElement = document.getElementById('status');
        const toggleButton = document.getElementById('toggleBtn');
        const emojiContainer = document.querySelector('.emoji-container');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendBtn');
        
        // åˆ›å»ºè¯­éŸ³è¯†åˆ«å¯¹è±¡
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        // è¯­éŸ³è¯†åˆ«å’Œè‡ªåŠ¨åˆ‡æ¢çŠ¶æ€å˜é‡
        let isRecognizing = false;
        let autoChangeInterval = null;
        let currentIndex = 0;
        let micPermissionGranted = false;
        
        // åˆå§‹åŒ–é¡µé¢ï¼Œä»åç«¯è·å–åˆå§‹çŠ¶æ€
        window.addEventListener('DOMContentLoaded', initializePage);

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // ä»åç«¯APIè·å–åˆå§‹çŠ¶æ€
            fetch(`${API_BASE_URL}/chat/init`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0 && data.data) {
                        updateRobotState(data.data.emoji, data.data.content);
                    }
                })
                .catch(error => {
                    console.error('è·å–åˆå§‹çŠ¶æ€å¤±è´¥:', error);
                });

            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition();

            // ç»‘å®šå‘é€æŒ‰é’®äº‹ä»¶
            sendButton.addEventListener('click', sendMessage);

            // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // å‘é€æ–‡æœ¬æ¶ˆæ¯åˆ°åç«¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // æ˜¾ç¤ºæ­£åœ¨æ€è€ƒçŠ¶æ€
            updateRobotState("ğŸ¤”", "æ­£åœ¨æ€è€ƒæ‚¨çš„é—®é¢˜...");
            
            // å‘é€æ¶ˆæ¯åˆ°åç«¯API
            fetch(`${API_BASE_URL}/chat/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: message,
                    userId: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 0 && data.data) {
                    updateRobotState(data.data.emoji, data.data.content);
                }
            })
            .catch(error => {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                updateRobotState("âš ï¸", "æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
        }
        
        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        function initSpeechRecognition() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                
                // è®¾ç½®è¯­éŸ³è¯†åˆ«å‚æ•°
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';
                
                // è®¾ç½®äº‹ä»¶å¤„ç†å‡½æ•°
                recognition.onstart = handleRecognitionStart;
                recognition.onend = handleRecognitionEnd;
                recognition.onresult = handleRecognitionResult;
                recognition.onerror = handleRecognitionError;
                
                // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                toggleButton.addEventListener('click', toggleRecognition);
            
                // å°è¯•é¢„å…ˆè·å–éº¦å…‹é£æƒé™
                requestMicrophonePermission();
            } else {
                // æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«
                displayWarning('âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                disableSpeechRecognition();
            }
        }
        
        // è¯·æ±‚éº¦å…‹é£æƒé™
        function requestMicrophonePermission() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    micPermissionGranted = true;
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(error => {
                    console.error('éº¦å…‹é£æƒé™è·å–å¤±è´¥:', error);
                    displayWarning('âš ï¸ è¯·æˆäºˆéº¦å…‹é£è®¿é—®æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³è¯†åˆ«');
                });
        }
        
        // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
        function displayWarning(message) {
            transcriptElement.innerHTML = `<div class="warning-message">${message}</div>`;
        }
        
        // ç¦ç”¨è¯­éŸ³è¯†åˆ«
        function disableSpeechRecognition() {
            toggleButton.disabled = true;
            toggleButton.textContent = 'è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨';
            statusElement.style.backgroundColor = '#ff4d4f';
        }
        
        // å¼€å§‹è‡ªåŠ¨åˆ‡æ¢
        function startAutoChange() {
            stopAutoChange();
            
            autoChangeInterval = setInterval(() => {
                // ä½¿ç”¨éšæœºè¡¨æƒ…å’Œå›å¤
                fetch(`${API_BASE_URL}/chat/init`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 0 && data.data) {
                            updateRobotState(data.data.emoji, data.data.content);
                        }
                    })
                    .catch(error => {
                        console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                    });
            }, 5000);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ‡æ¢
        function stopAutoChange() {
            if (autoChangeInterval) {
                clearInterval(autoChangeInterval);
                autoChangeInterval = null;
            }
        }
        
        // æ›´æ–°æœºå™¨äººçŠ¶æ€
        function updateRobotState(emoji, content) {
            emojiElement.textContent = emoji;
            responseElement.textContent = content;
            
            // é‡ç½®å¹¶è§¦å‘åŠ¨ç”»
            emojiContainer.style.animation = 'none';
            // è§¦å‘é‡ç»˜
            void emojiContainer.offsetWidth;
            emojiContainer.style.animation = 'emoji-enter 0.5s ease';
        }
        
        // å¤„ç†è¯†åˆ«å¼€å§‹äº‹ä»¶
        function handleRecognitionStart() {
            isRecognizing = true;
            statusElement.classList.add('active');
            toggleButton.textContent = 'åœæ­¢è¯†åˆ«';
            
            // æ¸…é™¤ä»»ä½•è­¦å‘Šä¿¡æ¯
            if (transcriptElement.querySelector('.warning-message')) {
                transcriptElement.innerHTML = '';
            }
            
            // åœæ­¢è‡ªåŠ¨åˆ‡æ¢ï¼Œæ˜¾ç¤ºæ€è€ƒè¡¨æƒ…
            stopAutoChange();
            updateRobotState("ğŸ¤”", "æ­£åœ¨å€¾å¬...");
        }
        
        // å¤„ç†è¯†åˆ«ç»“æŸäº‹ä»¶
        function handleRecognitionEnd() {
            isRecognizing = false;
            statusElement.classList.remove('active');
            toggleButton.textContent = 'å¼€å§‹è¯­éŸ³è¯†åˆ«';
        }
        
        // å¤„ç†è¯†åˆ«ç»“æœäº‹ä»¶
        function handleRecognitionResult(event) {
            let finalText = '';
            let interimText = '';
            
            // å¤„ç†è¯†åˆ«ç»“æœ
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalText += transcript;
                    
                    // å½“æœ‰æœ€ç»ˆç»“æœæ—¶ï¼Œå‘é€åˆ°åç«¯API
                    if (transcript.trim() !== '') {
                        sendTranscriptToBackend(transcript);
                    }
                } else {
                    interimText += transcript;
                }
            }
            
            // æ›´æ–°æ˜¾ç¤ºå†…å®¹
            transcriptElement.innerHTML = finalText.replace(/\n/g, '<br>') + 
                (interimText ? `<span class="interim">${interimText}</span>` : '');
        }
        
        // å‘é€è¯†åˆ«æ–‡æœ¬åˆ°åç«¯API
        function sendTranscriptToBackend(transcript) {
            fetch(`${API_BASE_URL}/chat/speech`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transcript: transcript,
                    userId: 1 // å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè®¾ç½®ç”¨æˆ·ID
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 0 && data.data) {
                    updateRobotState(data.data.emoji, data.data.content);
                }
            })
            .catch(error => {
                console.error('å‘é€è¯­éŸ³è¯†åˆ«æ–‡æœ¬å¤±è´¥:', error);
                updateRobotState("âš ï¸", "æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            });
        }
        
        // å¤„ç†è¯†åˆ«é”™è¯¯äº‹ä»¶
        function handleRecognitionError(event) {
            console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            
            switch (event.error) {
                case 'not-allowed':
                case 'permission-denied':
                    displayWarning('âš ï¸ è¯·æˆäºˆéº¦å…‹é£è®¿é—®æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³è¯†åˆ«');
                    disableSpeechRecognition();
                    updateRobotState("âš ï¸", "è¯·æˆäºˆéº¦å…‹é£è®¿é—®æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³è¯†åˆ«");
                    break;
                    
                case 'audio-capture':
                    displayWarning('âš ï¸ æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                    updateRobotState("âš ï¸", "æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡");
                    break;
                    
                case 'network':
                    displayWarning('âš ï¸ ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„äº’è”ç½‘è¿æ¥');
                    updateRobotState("âš ï¸", "ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„äº’è”ç½‘è¿æ¥");
                    break;
                    
                case 'aborted':
                    // ç”¨æˆ·æˆ–ç³»ç»Ÿä¸­æ­¢
                    break;
                    
                case 'no-speech':
                    // æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³
                    break;
                    
                default:
                    if (!isRecognizing) return; 
                    alert(`è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}`);
                    updateRobotState("âš ï¸", "è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
            }
        }
        
        // åˆ‡æ¢è¯­éŸ³è¯†åˆ«çŠ¶æ€
        function toggleRecognition() {
            if (isRecognizing) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                    
                    // å¤„ç†already starteré”™è¯¯
                    if (error.name === 'InvalidStateError') {
                        try {
                            recognition.stop();
                            setTimeout(() => recognition.start(), 200);
                        } catch (e) {
                            displayWarning('âš ï¸ è¯­éŸ³è¯†åˆ«æœåŠ¡å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    } else {
                        alert('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢');
                        updateRobotState("âš ï¸", "å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢");
                    }
                }
            }
        }
    </script>
</body>
</html> 